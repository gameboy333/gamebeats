extends Node2D

@export var recordingChart = false
@onready var noteInstance = preload("res://note.tscn")
var started = false
var noteRotations = {
	"left" = -180.0,
	"down" = 90.0,
	"up" = -90.0,
	"right" = 0.0,
}

var notePositions = {
	"left" = -263.097,
	"down" = -87.0,
	"up" = 86.903,
	"right" = 263.0,
}

var chartOutput = {
	"left": [],
	"down": [],
	"up": [],
	"right": []
}
@onready var chart = {
	"test" = {
		"scrollSpeed" = 15.0,
		"notes" = {
			"normal" = {
				"left": [[16.982494354248, 0], [19.0955104827881, 0], [22.1866664886475, 0], [24.8221321105957, 0], [26.8074378967285, 0.30000019073486], [29.8898868560791, 0], [34.1014060974121, 0], [39.6916084289551, 0], [41.1225395202637, 0.62199997901917], [43.8624954223633, 0.78099989891052], [46.1119270324707, 0], [46.2744674682617, 0], [46.4544219970703, 0], [46.7011337280273, 0], [48.1930160522461, 0], [51.734058380127, 0], [54.6684799194336, 0], [56.0558738708496, 0], [59.010612487793, 0], [61.323902130127, 0.29099988937378], [63.4136962890625, 0.3289999961853], [67.3930130004883, 0.31000018119812], [69.6656723022461, 0.35999989509583], [72.3853073120117, 0.45099997520447], [73.1109313964844, 1.11199998855591], [75.7551040649414, 0.30100011825562], [77.2905197143555, 0.46199989318848], [79.3396835327148, 0.2810001373291], [83.7572784423828, 0.29999995231628], [86.1344223022461, 0.26999998092651], [88.2358245849609, 0.5], [97.3757858276367, 0.76999998092651], [102.283897399902, 0], [105.44181060791, 0.2519998550415], [108.204986572266, 0.30000019073486], [110.614059448242, 0.27999997138977], [113.53687286377, 0], [114.967803955078, 1.20799994468689], [117.76000213623, 0], [119.275100708008, 0.25999999046326], [121.579681396484, 0], [125.962448120117, 0]], "down": [[16.6748294830322, 0.2519998550415], [17.2292060852051, 0], [18.5092067718506, 0], [19.3828563690186, 0], [21.5916557312012, 0], [22.3492069244385, 0], [24.6305675506592, 0], [25.0688438415527, 0], [26.3894786834717, 0], [27.0831737518311, 0.26900005340576], [29.6867122650146, 0], [30.0930614471436, 0], [33.909839630127, 0], [34.3800468444824, 0], [35.4249420166016, 1.72000002861023], [37.7179145812988, 0], [37.9646263122559, 0], [38.2200469970703, 0], [38.4986839294434, 0], [39.4361915588379, 0], [39.851245880127, 0], [40.8874359130859, 0], [41.7407722473145, 0], [43.1687965393066, 0], [43.6273918151855, 0], [44.6635818481445, 0], [47.0407257080078, 0], [47.2235832214355, 0], [47.4354629516602, 0], [47.8302040100098, 0], [48.4919738769531, 0.27199983596802], [49.0985946655273, 0], [50.102855682373, 0], [50.2624931335449, 0], [51.4786376953125, 0], [51.9575500488281, 0], [54.4972343444824, 0], [54.9035835266113, 0], [55.8933334350586, 0], [56.3199996948242, 0], [58.7842178344727, 0], [59.2660331726074, 0], [61.0771865844727, 0.26999998092651], [61.5909309387207, 0.45999979972839], [63.0508842468262, 0.31099987030029], [63.7358741760254, 0.34800004959106], [67.0940551757813, 0.27899980545044], [67.6716537475586, 0], [68.9516525268555, 0.51999998092651], [69.9965515136719, 0.48099994659424], [72.0021743774414, 0.40000009536743], [72.7800445556641, 0.35999989509583], [74.1877517700195, 0.40000009536743], [75.5199966430664, 0], [76.0221328735352, 0], [77.0467147827148, 0], [77.7491149902344, 0], [79.0639419555664, 0], [79.7344207763672, 0.28999996185303], [80.4600448608398, 0.27999997138977], [81.1421279907227, 0.27999997138977], [84.2884368896484, 0.25999999046326], [85.6235809326172, 0.46999979019165], [86.35791015625, 0], [88.7147369384766, 0.47000002861023], [91.9045791625977, 1.54099988937378], [94.0930633544922, 1.00099992752075], [96.0870742797852, 0], [97.1755065917969, 0], [98.1652603149414, 1.49199986457825], [102.092338562012, 0], [102.495780944824, 0], [104.341766357422, 0], [104.640724182129, 0.51100015640259], [105.813331604004, 0.61899995803833], [108.524261474609, 0.25999999046326], [109.824577331543, 0.29900002479553], [110.358642578125, 0], [110.901405334473, 0.25100016593933], [113.356918334961, 0], [113.77197265625, 0], [114.880722045898, 0], [116.427757263184, 0], [117.504577636719, 0], [118.018325805664, 0], [118.967437744141, 0.25999999046326], [119.521812438965, 0], [121.292335510254, 0], [121.750930786133, 0], [123.062858581543, 1.94299983978271], [125.750564575195, 0], [126.261405944824, 0]], "up": [[16.3439464569092, 0], [17.4846267700195, 0], [18.070930480957, 0], [18.7646255493164, 0], [19.6934242248535, 1.1489999294281], [21.4087982177734, 0], [22.5610885620117, 0], [23.1067581176758, 1.32100009918213], [25.3561897277832, 0], [25.8670291900635, 0], [26.6681175231934, 0], [27.3734245300293, 0], [27.8204078674316, 0], [29.3993644714355, 0], [30.4645805358887, 0.29999995231628], [30.9783210754395, 0], [33.5789566040039, 0.29100012779236], [34.6151466369629, 0], [35.1492080688477, 0], [37.6018142700195, 0], [37.8456230163574, 0], [38.103946685791, 0], [38.3680725097656, 0], [38.8498878479004, 0], [39.1807708740234, 0], [40.0863494873047, 0.30999994277954], [40.7278022766113, 0], [41.9439468383789, 0], [42.4228553771973, 0], [42.9133796691895, 0], [43.3400459289551, 0.25], [44.7999992370605, 0], [46.1786842346191, 0], [46.3789558410645, 0], [46.5385932922363, 0], [47.6908836364746, 0], [48.3439445495605, 0], [49.2379150390625, 0.53999996185303], [50.4540596008301, 0.26800012588501], [50.9678001403809, 0], [52.2361907958984, 0.53999996185303], [53.069206237793, 0], [54.3375968933105, 0], [55.1386833190918, 0], [55.6495246887207, 0], [57.1414070129395, 0], [57.4635810852051, 0.30099987983704], [59.5098419189453, 0.25200009346008], [59.9916534423828, 0.27899980545044], [60.482177734375, 0.57000017166138], [62.1133804321289, 0.31900000572205], [62.6793632507324, 0.37000012397766], [64.0754623413086, 0.42900013923645], [64.7575531005859, 1.8899998664856], [67.895149230957, 0.29999995231628], [68.4292068481445, 0.28099989891052], [69.4189605712891, 0.30999994277954], [70.4754638671875, 0.28800010681152], [70.9892044067383, 0.41000008583069], [71.6916122436523, 0.31199979782104], [74.5941009521484, 0.26199984550476], [75.0933303833008, 0.41899991035461], [76.2775497436523, 0.29999995231628], [76.8116073608398, 0], [78.007438659668, 0], [78.8172302246094, 0], [80.0856246948242, 0.33199977874756], [81.4294815063477, 2.242999792099], [84.0214080810547, 0.28999996185303], [84.8544235229492, 0.29999995231628], [85.3971862792969, 0], [86.656867980957, 0.46099996566772], [87.414421081543, 0.32999992370605], [89.1965560913086, 0.56100010871887], [90.7842178344727, 1.04900002479553], [93.4516067504883, 0.67900013923645], [95.0828094482422, 1.0], [96.2583236694336, 0], [96.9926528930664, 0], [99.9589996337891, 0], [101.877548217773, 0], [102.722175598145, 0.61899995803833], [104.46947479248, 0], [104.864219665527, 0.60899996757507], [106.454788208008, 1.15000009536743], [108.823219299316, 0.27099990844727], [109.322448730469, 0], [110.17578125, 0], [111.127799987793, 0], [111.606712341309, 0], [113.226303100586, 0], [114.015785217285, 0], [114.358276367188, 0.2519998550415], [116.575782775879, 0.31099987030029], [117.196914672852, 0], [118.273742675781, 0], [118.700408935547, 0], [119.71337890625, 0], [120.021041870117, 1.0], [121.994735717773, 0], [122.656509399414, 0], [125.431289672852, 0.28999996185303], [126.847709655762, 0], [127.341133117676, 1.26099991798401]], "right": [[16.1814060211182, 0], [17.7835826873779, 0], [18.2741050720215, 0], [21.1214504241943, 0], [21.8267574310303, 0], [22.8600444793701, 0], [25.6116104125977, 0], [26.1021308898926, 0.2590000629425], [27.6056232452393, 0], [27.9481182098389, 1.26099991798401], [30.7867565155029, 0], [31.1379585266113, 1.64199995994568], [34.9779586791992, 0], [38.6583213806152, 0], [38.9892082214355, 0], [40.4926986694336, 0], [42.1877555847168, 0], [42.6782760620117, 0], [44.919002532959, 0.80799984931946], [47.0639457702637, 0], [47.3193664550781, 0], [48.0769157409668, 0], [48.8228569030762, 0.28099989891052], [50.7210884094238, 0], [51.1796836853027, 0.29999995231628], [53.2491607666016, 0.91899991035461], [55.3941040039063, 0], [57.3039474487305, 0], [59.7333335876465, 0], [60.2470741271973, 0], [62.4239463806152, 0.28999996185303], [64.4905242919922, 0.28999996185303], [68.1708831787109, 0.29099988937378], [68.6614074707031, 0.27999997138977], [70.7308807373047, 0.27999997138977], [71.3723373413086, 0.35099983215332], [74.8698425292969, 0.26099991798401], [76.5765075683594, 0.26900005340576], [78.2947845458984, 0.41799998283386], [80.7706146240234, 0.40899991989136], [84.5670776367188, 0.27900004386902], [85.1417694091797, 0.27900004386902], [87.2228546142578, 0], [87.71337890625, 0.52999997138977], [89.8031768798828, 0.97999978065491], [96.3744201660156, 0.58099985122681], [99.6919708251953, 0], [100.182495117188, 1.53200006484985], [103.404266357422, 0.84200000762939], [105.633377075195, 0], [108.022132873535, 0], [109.078636169434, 0.25099992752075], [109.548843383789, 0.27799987792969], [111.351295471191, 0], [111.798278808594, 0.91100001335144], [112.962173461914, 0.27100014686584], [114.134780883789, 0.2590000629425], [114.593376159668, 0.3199999332428], [116.906669616699, 0.26900005340576], [118.529159545898, 0], [120.00072479248, 1.04099988937378], [122.369163513184, 0], [122.859680175781, 0], [126.528434753418, 0.2889997959137], [127.082809448242, 0.26900005340576]]
			}
		}
	}
}
@onready var currentChart = chart["test"]
var pressedKeys = {
	"left":false,
	"down":false,
	"up":false,
	"right":false,
}

func startSong():
	if not started:
		started = true
		if !recordingChart:
			var notes = currentChart["notes"]["normal"]
			for arrowType in notes:
				for data in notes[arrowType]:
					var pos = data[0]
					var holdLength = data[1]
					var note_spawn_time = clamp(pos - (1110 / (currentChart["scrollSpeed"]*60)),0,INF)
					note_spawn_time -= AudioServer.get_output_latency()
					spawnKey(arrowType,note_spawn_time,holdLength)
		else:
			gameVals.keyPress.connect(onKeyPress)

func spawnKey(direction,delay,holdLength):
	await get_tree().create_timer(delay).timeout
	var newKey = noteInstance.instantiate()
	call_deferred("add_child",newKey)
	newKey.noteDirection = direction
	newKey.find_child("Arrow").rotation_degrees = noteRotations[direction]
	newKey.add_to_group(StringName(direction),true)
	newKey.noteSpeed = chart["test"]["scrollSpeed"]
	
	if holdLength > 0:
		newKey.holdNote = true
		newKey.holdLen = holdLength
	
	newKey.setup(notePositions[direction])

func onKeyPress(key):
	if pressedKeys[key] == false:
		print(key)
		pressedKeys[key] = true
		var list = []
		var place = $"../Conductor".get_playback_position()
		list.append(place)
		var started = Time.get_unix_time_from_system()
		while Input.is_action_pressed(key):
			await get_tree().create_timer(0).timeout
		var holdLength = Time.get_unix_time_from_system() - started
		if holdLength < .25:
			holdLength = 0
		list.append(holdLength)
		chartOutput[key].append(list)
		pressedKeys[key] = false
		print(chartOutput)
